link(rel="stylesheet" type="text/css" href=url_for(theme.asset.katex))
script(data-pjax).
  function initKatexRender() {
    if (typeof renderMathInElement !== 'function') {
      console.warn('[KaTeX] renderMathInElement 未加载，跳过渲染');
      return;
    }
    
    renderMathInElement(document.body, {
      delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '$', right: '$', display: false}
      ],
      throwOnError: false,
      strict: false,
      trust: true
    });
    
    document.querySelectorAll('#article-container span.katex-display').forEach(item => {
      anzhiyu.wrap(item, 'div', { class: 'katex-wrap'})
    });
  }
  
  function loadScript(src) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }
  
  Promise.resolve()
    .then(() => loadScript('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js'))
    .then(() => loadScript('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/mhchem.min.js'))
    .then(() => loadScript('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js'))
    .then(() => loadScript('!{url_for(theme.asset.katex_copytex)}'))
    .then(() => {
      initKatexRender();
    })
    .catch(err => {
      console.error('[KaTeX] 脚本加载失败:', err);
    });
  